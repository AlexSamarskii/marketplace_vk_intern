# Advertisement Service

Сервис объявлений с регистрацией пользователей, авторизацией и CRUD-операциями для объявлений.  
Проект реализован на Go с использованием `http.ServeMux` для роутинга, PostgreSQL для хранения данных и Docker Compose для локального запуска.
В реализации сервиса в качестве токена авторизации используется сеансовый токен (session_id) в cookie. Сервер хранит состояние сессии в Redis. 
Дополнительно используется CSRF‑механизм для защиты state‑changing запросов из браузера.

---

## **Структура API**

### **Маршруты `/ad`**
| Метод | Ручка        | Описание |
|-------|--------------|----------|
| `POST` | `/api/v1/ad/create` | Создание нового объявления |
| `GET`  | `/api/v1/ad/{id}`   | Получение информации об объявлении по ID |
| `GET`  | `/api/v1/ad/all`    | Получение списка всех объявлений (с фильтрацией и сортировкой) |

---

### **Маршруты `/auth`**
| Метод | Ручка         | Описание |
|-------|---------------|----------|
| `GET`  | `/api/v1/auth/isAuth`   | Проверка текущей сессии |
| `POST` | `/api/v1/auth/logout`   | Выход из текущей сессии |
| `POST` | `/api/v1/auth/logoutAll`| Выход из всех сессий пользователя |

---

### **Маршруты `/user`**
| Метод | Ручка             | Описание |
|-------|-------------------|----------|
| `POST` | `/api/v1/user/register`   | Регистрация нового пользователя |
| `POST` | `/api/v1/user/login`      | Авторизация (получение токена) |
| `GET`  | `/api/v1/user/profile/{id}` | Получение профиля пользователя по ID |

---

### **Служебные маршруты**
| Метод | Ручка             | Описание |
|-------|-------------------|----------|
| `GET` | `/health`          | Проверка состояния сервиса |
| `GET` | `/swagger/`        | Swagger UI (документация API) |

---
## **Структура .env файла**

Пример `.env` файла:
```env
# PostgreSQL
POSTGRES_HOST=postgres
POSTGRES_CONTAINER_PORT=5432
POSTGRES_HOST_PORT=8070
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_DB=postgres

# Redis
REDIS_HOST=redis
REDIS_CONTAINER_PORT=6379
REDIS_HOST_PORT=8090
REDIS_PASSWORD=

# App
SERVER_PORT=8000
CSRF_SECRET=9999C55C15065A69AB991BA798A4A498
```

## **Swagger**
Swagger-документация доступна по адресу:
http://localhost:8000/swagger/index.html


Файл спецификации находится в `./docs/swagger.yaml`.

---

## **Запуск проекта**

### **1. Установите Docker и Docker Compose**  
Убедитесь, что у вас установлены:
- [Docker](https://docs.docker.com/get-docker/)
- [Docker Compose](https://docs.docker.com/compose/install/)

---

### **2. Запустите проект**
```bash
docker-compose up --build
```

### **Пример запроса**
```bash
curl -X POST http://localhost:8000/api/v1/ad/create \
-H "Content-Type: application/json" \
-d '{
  "title": "Продам велосипед",
  "description": "Горный велосипед, отличное состояние",
  "price": 10000,
  "image_url": "https://example.com/bike.jpg"
}'
```
Структура `Advertisement` включает поля: `Title`, `Description`, `ImageURL`, `Price`, `UserID`, `AuthorLogin`, `IsMine`, `CreatedAt`, `UpdatedAt`.

---

## Основные правила валидации

### Объявление

1. **Title**  
   - Обязательное поле.
   - Длина от **3** до **50** символов.
   
2. **Description**  
   - Обязательное поле.
   - Длина от **10** до **500** символов.

3. **ImageURL**  
   - Обязательное поле.
   - Корректный URL.
   - Разрешённые расширения: `.jpg`, `.jpeg`, `.png`, `.gif`.
   - Максимальная длина URL — **2048** символов.

4. **Price**  
   - Обязательное поле.
   - Значение от **0.0** до **1 000 000 000**.

5. **UserID**  
   - Должен быть **> 0**.

## Проверка удалённых изображений
- Отправка HEAD-запроса для проверки доступности.
- Проверка `Content-Type` (`image/*`).
- Проверка размера (максимум **5MB**).
- Считывание первых 512KB изображения для проверки размеров:
  - Максимальная ширина/высота — **4096x4096**.

### Пользователь

1. **Логин (`Login`)**
   - Должен быть непустым.
   - Разрешены только буквы и цифры (a-z, A-Z, 0-9).
   - Длина должна быть от **3 до 50 символов**.

2. **Имя (`Name`)**
   - Обязательно.
   - Может содержать только буквы (включая Unicode).
   - Длина — от **1 до 100 символов**.

3. **Фамилия (`Surname`)**
   - Обязательно.
   - Может содержать только буквы (включая Unicode).
   - Длина — от **1 до 100 символов**